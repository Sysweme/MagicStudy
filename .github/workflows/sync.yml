name: Sync Notion to GitHub

on:
  # 每天凌晨 2 点自动运行 (UTC 时间，北京时间需 +8)
  schedule:
    - cron: '0 18 * * *'
  # 允许手动触发
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install @notionhq/client glob fs

      # 这里使用一个简单的 Node.js 脚本来演示逻辑
      - name: Generate Markdown with Structure
        env:
          NOTION_TOKEN: $
          NOTION_DATABASE_ID: $
        run: |
          # 创建一个临时脚本文件
          cat > sync.js << 'EOL'
          const { Client } = require("@notionhq/client");
          const fs = require("fs");
          const path = require("path");

          // 1. 初始化客户端
          const notion = new Client({ auth: process.env.NOTION_TOKEN });

          // 2. 递归函数：遍历页面树并保持结构
          async function traverseAndSave(blockId, currentPath = "./output") {
            const response = await notion.blocks.children.list({ block_id: blockId });

            // 确保当前层级的文件夹存在
            if (!fs.existsSync(currentPath)) {
              fs.mkdirSync(currentPath, { recursive: true });
            }

            for (const block of response.results) {
              // 处理不同类型的内容 (段落、标题等)
              let content = "";
              if (block.type === "paragraph") {
                content = block.paragraph.rich_text.map(t => t.plain_text).join("");
              } else if (block.type.startsWith("heading")) {
                const level = block.type === "heading_1" ? "#" : block.type === "heading_2" ? "##" : "###";
                content = `${level} ${block[block.type].rich_text[0].plain_text}`;
              }

              // 如果是子页面 (关键：创建子文件夹)
              if (block.type === "child_page") {
                const pageName = block.child_page.title;
                // 清理文件名中的非法字符
                const safeName = pageName.replace(/[^a-zA-Z0-9\u4e00-\u9fa5._-]/g, '-');
                
                // 递归进入子页面，路径变为 currentPath/subFolder
                await traverseAndSave(block.id, path.join(currentPath, safeName));
                
                // 在子文件夹中生成 README.md 或 index.md
                fs.writeFileSync(path.join(currentPath, safeName, "index.md"), `# ${pageName}\n\n<!-- 内容由 Notion 同步 -->\n`);
              } 
              
              // 如果是普通文本块，写入当前目录的文件
              else if (content) {
                // 追加内容到当前目录的 content.md (或者根据需求调整)
                fs.appendFileSync(path.join(currentPath, "content.md"), content + "\n\n");
              }
            }
          }

          // 3. 开始从顶级页面同步
          (async () => {
            try {
              await traverseAndSave(process.env.NOTION_PAGE_ID);
              console.log("同步完成，结构已保持");
            } catch (error) {
              console.error(error);
              process.exit(1);
            }
          })();
          EOL

          # 运行脚本
          node sync.js

      # 4. 提交文件到 GitHub
      - name: Commit and Push
        run: |
          git config user.name "Notion Bot"
          git config user.email "notion@example.com"
          git add .
          git diff --quiet && git diff --staged --quiet || git commit -m "feat: auto sync notion pages $(date)"
          git push origin main
