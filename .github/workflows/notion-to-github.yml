name: ğŸ”„ æ‰¹é‡åŒæ­¥ Notion é¡µé¢åˆ° GitHub
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  sync-notion:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: pip install notion-sdk-py python-dotenv markdownify

      - name: è¿è¡Œæ‰¹é‡å¯¼å‡ºè„šæœ¬
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_PAGE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          # åˆ›å»ºå¯¼å‡ºç›®å½•
          mkdir -p ./notion-exports
          # å†™å…¥è‡ªå®šä¹‰è„šæœ¬
          cat > notion-export.py << 'EOF'
          import os
          import re
          from notion_client import Client
          from markdownify import markdownify as md
          from pathlib import Path

          # åˆå§‹åŒ– Notion å®¢æˆ·ç«¯
          notion = Client(auth=os.environ.get("NOTION_TOKEN"))
          root_page_id = os.environ.get("NOTION_PAGE_ID")
          output_dir = Path("./notion-exports")

          # é€’å½’è·å–æ‰€æœ‰å­é¡µé¢
          def get_all_pages(page_id, parent_path):
              try:
                  # è·å–å½“å‰é¡µé¢å†…å®¹
                  page = notion.pages.retrieve(page_id=page_id)
                  page_title = page["properties"].get("title", {}).get("title", [{}])[0].get("plain_text", "Untitled")
                  # æ¸…ç†æ ‡é¢˜ä¸­çš„éæ³•å­—ç¬¦
                  page_title = re.sub(r'[<>:"/\\|?*]', "_", page_title)
                  current_path = parent_path / page_title

                  # è·å–é¡µé¢å—å†…å®¹
                  blocks = notion.blocks.children.list(block_id=page_id)["results"]
                  content = []
                  for block in blocks:
                      if block["type"] == "paragraph" and block["paragraph"]["rich_text"]:
                          content.append(md(str(block["paragraph"]["rich_text"])))
                      elif block["type"] == "heading_1" and block["heading_1"]["rich_text"]:
                          content.append(f"# {md(str(block['heading_1']['rich_text']))}")
                      elif block["type"] == "heading_2" and block["heading_2"]["rich_text"]:
                          content.append(f"## {md(str(block['heading_2']['rich_text']))}")
                      elif block["type"] == "heading_3" and block["heading_3"]["rich_text"]:
                          content.append(f"### {md(str(block['heading_3']['rich_text']))}")
                      # å¯æ‰©å±•æ”¯æŒæ›´å¤šå—ç±»å‹ï¼ˆå¦‚åˆ—è¡¨ã€å›¾ç‰‡ï¼‰

                  # å†™å…¥ Markdown æ–‡ä»¶
                  with open(current_path.with_suffix(".md"), "w", encoding="utf-8") as f:
                      f.write("\n\n".join(content))

                  # é€’å½’å¤„ç†å­é¡µé¢
                  for block in blocks:
                      if block["type"] == "child_page":
                          get_all_pages(block["id"], current_path.parent)
              except Exception as e:
                  print(f"å¤„ç†é¡µé¢ {page_id} å¤±è´¥: {e}")

          # å¯åŠ¨é€’å½’å¯¼å‡º
          get_all_pages(root_page_id, output_dir)
          print("æ‰¹é‡å¯¼å‡ºå®Œæˆï¼")
          EOF
          # æ‰§è¡Œè„šæœ¬
          python notion-export.py

      - name: æäº¤å¹¶æ¨é€
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add ./notion-exports/*
          if ! git diff --staged --quiet; then
            git commit -m "æ‰¹é‡åŒæ­¥ Notion é¡µé¢ $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          else
            echo "æ— é¡µé¢å˜æ›´ï¼Œè·³è¿‡æäº¤"
          fi