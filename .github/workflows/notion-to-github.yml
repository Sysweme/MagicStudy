name: ğŸ”„ æ‰¹é‡åŒæ­¥ Notion é¡µé¢åˆ° GitHub
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  sync-notion:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # å…³é”®ï¼šç¡®ä¿ pip å¯ç”¨å¹¶å‡çº§
          cache: 'pip'

      - name: å¼ºåˆ¶å®‰è£…ä¾èµ–ï¼ˆè§£å†³æ¨¡å—ç¼ºå¤±ï¼‰
        run: |
          python -m pip install --upgrade pip
          pip install --force-reinstall notion-sdk-py python-dotenv markdownify
          # éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸ
          pip list | grep notion-sdk-py

      - name: è¿è¡Œæ‰¹é‡å¯¼å‡ºè„šæœ¬
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_PAGE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          mkdir -p ./notion-exports
          cat > notion-export.py << 'EOF'
          import os
          import re
          from notion_client import Client
          from markdownify import markdownify as md
          from pathlib import Path

          notion = Client(auth=os.environ.get("NOTION_TOKEN"))
          root_page_id = os.environ.get("NOTION_PAGE_ID")
          output_dir = Path("./notion-exports")
          output_dir.mkdir(exist_ok=True)

          def get_all_pages(page_id, parent_path):
              try:
                  page = notion.pages.retrieve(page_id=page_id)
                  page_title = page["properties"].get("title", {}).get("title", [{}])[0].get("plain_text", "Untitled")
                  page_title = re.sub(r'[<>:"/\\|?*]', "_", page_title)
                  current_path = parent_path / f"{page_title}.md"

                  blocks = notion.blocks.children.list(block_id=page_id)["results"]
                  content = []
                  for block in blocks:
                      if block["type"] == "paragraph" and block["paragraph"]["rich_text"]:
                          content.append(md(str(block["paragraph"]["rich_text"])))
                      elif block["type"] == "heading_1" and block["heading_1"]["rich_text"]:
                          content.append(f"# {md(str(block['heading_1']['rich_text']))}")
                      elif block["type"] == "heading_2" and block["heading_2"]["rich_text"]:
                          content.append(f"## {md(str(block['heading_2']['rich_text']))}")
                      elif block["type"] == "heading_3" and block["heading_3"]["rich_text"]:
                          content.append(f"### {md(str(block['heading_3']['rich_text']))}")
                      elif block["type"] == "bulleted_list_item" and block["bulleted_list_item"]["rich_text"]:
                          content.append(f"- {md(str(block['bulleted_list_item']['rich_text']))}")
                      elif block["type"] == "numbered_list_item" and block["numbered_list_item"]["rich_text"]:
                          content.append(f"1. {md(str(block['numbered_list_item']['rich_text']))}")

                  with open(current_path, "w", encoding="utf-8") as f:
                      f.write("\n\n".join(content))

                  for block in blocks:
                      if block["type"] == "child_page":
                          get_all_pages(block["id"], parent_path)
              except Exception as e:
                  print(f"å¤„ç†é¡µé¢ {page_id} å¤±è´¥: {e}")

          get_all_pages(root_page_id, output_dir)
          print("æ‰¹é‡å¯¼å‡ºå®Œæˆï¼")
          EOF
          python notion-export.py

      - name: æäº¤å¹¶æ¨é€
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add ./notion-exports/*
          if ! git diff --staged --quiet; then
            git commit -m "æ‰¹é‡åŒæ­¥ Notion é¡µé¢ $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          else
            echo "æ— é¡µé¢å˜æ›´ï¼Œè·³è¿‡æäº¤"
          fi